<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k3s Suite</title>
    <link rel="stylesheet" href="style.css">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
    <style>
        .CodeMirror {
            height: 100%;
            font-size: 14px;
            border: 1px solid #444;
        }

        #network-map-container {
            width: 100%;
            height: 600px;
            border: 1px solid #444;
            background: #222;
        }
    </style>
    <!-- Vis.js -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Internet Access Disclaimer -->
    <div id="internet-disclaimer"
        style="background: #ff9800; color: #000; padding: 10px; text-align: center; display: none;">
        <strong>Notice:</strong> This application uses external libraries (CodeMirror, Vis.js) which require internet
        access. In air-gapped environments, the YAML Editor and Network Map may be unavailable.
        <button
            onclick="document.getElementById('internet-disclaimer').style.removeProperty('display'); document.getElementById('internet-disclaimer').style.display = 'none';"
            style="background:none; border:none; cursor:pointer; font-weight:bold; margin-left:10px;">[Dismiss]</button>
    </div>

    <div class="container">
        <header
            style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1f1f1f; border-bottom: 1px solid #444;">
            <h1 style="margin: 0; font-size: 1.5em; color: white;">k3s Suite</h1>
            <button onclick="showNetworkMap()" class="btn-classy">
                View Cluster Map
            </button>
        </header>
        <div id="sidebar">

            <div style="padding: 10px; border-bottom: 1px solid #444;">
                <label for="context-selector"
                    style="display:block; margin-bottom:5px; font-size:0.9em; color:#aaa;">Cluster / Context:</label>
                <select id="context-selector"
                    style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 3px;"
                    onchange="switchContext(this.value)">
                    <option>Loading...</option>
                </select>
            </div>
            <div class="content">
                <div class="sidebar">
                    <button onclick="showContent('nodes')">Nodes</button>
                    <button onclick="showContent('deployments')">Deployments</button>
                    <button onclick="showContent('pods')">Pods</button>
                    <button onclick="showContent('services')">Services</button>
                    <button onclick="showContent('ingresses')">Ingresses</button>
                    <button onclick="showContent('daemonsets')">DaemonSets</button>
                    <button onclick="showContent('statefulsets')">StatefulSets</button>
                    <button onclick="showContent('jobs')">Jobs</button>
                    <button onclick="showContent('cronjobs')">CronJobs</button>
                    <button onclick="showContent('configmaps')">ConfigMaps</button>
                    <button onclick="showContent('secrets')">Secrets</button>
                    <button onclick="showContent('repositories')">Repositories</button>
                </div>
                <div class="main-content">
                    <div class="namespace-filter">
                        <label for="namespace-select">Namespace:</label>
                        <select id="namespace-select" onchange="filterByNamespace()">
                            <option value="all">All Namespaces</option>
                        </select>
                    </div>
                    <div id="nodes-content" class="page-content">
                        <div class="page-header">
                            <h2>Nodes</h2>
                            <button onclick="fetchAndRenderNodes()">Refresh</button>
                        </div>
                        <table id="nodes-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Version</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="deployments-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Deployments</h2>
                            <button onclick="fetchAndRenderDeployments()">Refresh</button>
                        </div>
                        <table id="deployments-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Replicas</th>
                                    <th>Ready Replicas</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="pods-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Pods</h2>
                            <button onclick="fetchAndRenderPods()">Refresh</button>
                        </div>
                        <table id="pods-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Node</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="services-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Services</h2>
                            <button onclick="fetchAndRenderServices()">Refresh</button>
                        </div>
                        <table id="services-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Cluster IP</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="ingresses-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Ingresses</h2>
                            <button onclick="fetchAndRenderIngresses()">Refresh</button>
                        </div>
                        <table id="ingresses-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Hosts</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="daemonsets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>DaemonSets</h2>
                            <button onclick="fetchAndRenderDaemonSets()">Refresh</button>
                        </div>
                        <table id="daemonsets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Desired</th>
                                    <th>Current</th>
                                    <th>Ready</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="statefulsets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>StatefulSets</h2>
                            <button onclick="fetchAndRenderStatefulSets()">Refresh</button>
                        </div>
                        <table id="statefulsets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Replicas</th>
                                    <th>Ready Replicas</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="jobs-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Jobs</h2>
                            <button onclick="fetchAndRenderJobs()">Refresh</button>
                        </div>
                        <table id="jobs-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Completions</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="cronjobs-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>CronJobs</h2>
                            <button onclick="fetchAndRenderCronJobs()">Refresh</button>
                        </div>
                        <table id="cronjobs-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Schedule</th>
                                    <th>Last Schedule</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="configmaps-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>ConfigMaps</h2>
                            <button onclick="fetchAndRenderConfigMaps()">Refresh</button>
                        </div>
                        <table id="configmaps-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="secrets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Secrets</h2>
                            <button onclick="fetchAndRenderSecrets()">Refresh</button>
                        </div>
                        <table id="secrets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="repositories-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Repositories</h2>
                        </div>

                        <div id="registry-setup"
                            style="display: none; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px;">
                            <h3>Registry Setup</h3>
                            <p>Configure your local Docker Registry.</p>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-url" style="display:block; margin-bottom:5px;">Registry URL (e.g.
                                    localhost:5000):</label>
                                <input type="text" id="registry-url" placeholder="localhost:5000"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-username" style="display:block; margin-bottom:5px;">Username
                                    (Optional):</label>
                                <input type="text" id="registry-username" placeholder="Username"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-password" style="display:block; margin-bottom:5px;">Password
                                    (Optional):</label>
                                <input type="password" id="registry-password" placeholder="Password"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="checkbox" id="registry-secure">
                                <label for="registry-secure">Use Secure Connection (SSL)</label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-timezone" style="display:block; margin-bottom:5px;">Time
                                    Zone:</label>
                                <select id="registry-timezone" style="padding: 0.5em; width: 300px;">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (US & Canada)</option>
                                    <option value="America/Chicago">Central Time (US & Canada)</option>
                                    <option value="America/Denver">Mountain Time (US & Canada)</option>
                                    <option value="America/Los_Angeles">Pacific Time (US & Canada)</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                    <option value="Asia/Calcutta">India Standard Time</option>
                                </select>
                            </div>
                            <button onclick="saveRegistryConfig()">Save Configuration</button>
                            <button onclick="document.getElementById('registry-setup').style.display='none'"
                                style="margin-left: 10px; background: transparent; border: 1px solid #555;">Cancel</button>
                        </div>

                        <div id="registry-error"
                            style="display: none; padding: 20px; background-color: #330000; border: 1px solid #ff4444; border-radius: 5px; margin-bottom: 20px; color: #ffcccc;">
                            <h3 style="margin-top: 0;">Error</h3>
                            <p id="registry-error-msg"></p>
                            <!-- ... instructions ... -->
                        </div>

                        <!-- New Registry UI -->
                        <div id="registry-container">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input type="text" id="repo-search" placeholder="Search repositories..."
                                    style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #333; color: white;"
                                    onkeyup="filterRepositories()">
                                <button class="btn btn-classy" onclick="loadRegistryImages()">Refresh</button>
                                <button class="btn btn-classy"
                                    onclick="document.getElementById('registry-setup').style.display='block'">Settings</button>
                            </div>

                            <div id="registry-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <!-- Repositories populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Resource Button (FAB) -->
            <button class="fab" onclick="openCreateModal()" title="Create Resource">
                +
                <span class="fab-tooltip">Create Resource</span>
            </button>

            <div id="create-resource-modal" class="modal">
                <div class="modal-content" style="width: 80%; max-width: 800px;">
                    <span class="close" onclick="closeCreateModal()">&times;</span>
                    <h2>Create Resource</h2>

                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label>Start From:</label>
                            <select id="create-mode-select" onchange="toggleCreateMode()">
                                <option value="template">New from Template</option>
                                <option value="clone">Clone Existing Resource</option>
                            </select>
                        </div>
                    </div>

                    <!-- Template Options -->
                    <div id="create-template-options" style="display: block; margin-bottom: 15px;">
                        <label>Resource Type:</label>
                        <select id="template-type-select" onchange="loadTemplate()">
                            <option value="">Select a type...</option>
                            <option value="deployment">Deployment</option>
                            <option value="service">Service</option>
                            <option value="pvc">PersistentVolumeClaim</option>
                            <option value="configmap">ConfigMap</option>
                            <option value="secret">Secret</option>
                            <option value="ingress">Ingress</option>
                        </select>
                    </div>

                    <!-- Clone Options -->
                    <div id="create-clone-options"
                        style="display: none; margin-bottom: 15px; border: 1px solid #444; padding: 10px; border-radius: 8px;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <label>Namespace</label>
                                <select id="clone-ns-select" onchange="loadCloneResources()">
                                    <!-- populated by js -->
                                </select>
                            </div>
                            <div>
                                <label>Type</label>
                                <select id="clone-type-select" onchange="loadCloneResources()">
                                    <option value="deployments">Deployment</option>
                                    <option value="services">Service</option>
                                    <option value="configmaps">ConfigMap</option>
                                    <option value="secrets">Secret</option>
                                </select>
                            </div>
                            <div>
                                <label>Resource</label>
                                <select id="clone-resource-select" onchange="fetchCloneYaml()">
                                    <option value="">Select resource...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="create-editor-container" style="height: 400px; border: 1px solid #444;"></div>

                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="margin: 0; color: #ddd;">Target Namespace:</label>
                            <select id="create-target-ns" style="width: 200px; margin: 0;"
                                onchange="updateYamlNamespace()">
                                <option value="">Use YAML / Default</option>
                                <!-- populated by js -->
                            </select>
                        </div>

                        <div style="text-align: right;">
                            <button class="btn-classy" onclick="closeCreateModal()">Cancel</button>
                            <button class="btn-classy primary" onclick="applyResource()">Apply to Cluster</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="yaml-modal" class="modal" data-resource-url="">
                <div class="modal-content">
                    <span class="close" onclick="closeYamlModal()">&times;</span>
                    <!-- Replaced textarea with div for CodeMirror, though CM can replace textarea automatically -->
                    <textarea id="yaml-content"
                        style="display:none; width: 100%; height: calc(100% - 60px); background: #333; color: white; padding: 10px; border: 1px solid #444;"></textarea>
                    <div id="codemirror-container" style="height: calc(100% - 60px);"></div>
                    <div id="yaml-editor-warning" style="color: orange; display: none; margin-bottom: 5px;">Offline
                        Mode:
                        Syntax validation unavailable.</div>
                    <div class="modal-actions">
                        <button onclick="copyYamlToClipboard()">Copy to Clipboard</button>
                        <button id="edit-yaml-btn" onclick="enableYamlEditing()">Edit</button>
                        <button id="save-yaml-btn" onclick="saveYaml()" style="display: none;">Save</button>
                    </div>
                </div>
            </div>

            <div id="network-map-modal" class="modal">
                <div class="modal-content" style="width: 95%; height: 95%; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #444;">
                        <h2 style="margin: 0;">Cluster Network Map</h2>
                        <span class="close" onclick="closeNetworkMap()" style="font-size: 28px;">&times;</span>
                    </div>

                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label for="map-namespace-select">Namespace:</label>
                            <select id="map-namespace-select" onchange="renderNetworkMap()">
                                <option value="all">All Namespaces</option>
                            </select>
                            <button onclick="renderNetworkMap()">Refresh Map</button>
                        </div>
                        <div>
                            <button id="btn-install-otterize" onclick="installOtterize()"
                                style="background: #e91e63; display: none;">Install Otterize (Enable Mapping)</button>
                        </div>
                    </div>

                    <!-- Main Content Area: Flex Row -->
                    <div style="display: flex; flex: 1; gap: 10px; overflow: hidden;">
                        <!-- Left: Map -->
                        <div style="flex: 3; display: flex; flex-direction: column;">
                            <!-- Installation Instructions -->
                            <div id="otterize-instructions"
                                style="display:none; padding:10px; background:#333; margin-bottom:10px; border-radius:5px;">
                                <p><strong>Otterize CLI Required for Full Features</strong></p>
                                <p>To view traffic map, Otterize must be installed in the cluster. Click "Install
                                    Otterize"
                                    above to install components.</p>
                                <p>For local CLI usage:</p>
                                <pre style="background:#111; padding:5px;">brew install otterize/otterize/otterize</pre>
                            </div>
                            <div id="network-map-container" style="flex: 1; border: 1px solid #444; background: #222;">
                            </div>
                        </div>

                        <!-- Right: Side Panel -->
                        <div id="map-side-panel"
                            style="flex: 1; background: #2a2a2a; border: 1px solid #444; display: flex; flex-direction: column;">
                            <div
                                style="padding: 10px; background: #333; font-weight: bold; border-bottom: 1px solid #444;">
                                Access Graph
                            </div>
                            <div style="flex: 1; overflow: auto; padding: 10px;">
                                <pre id="access-graph-text"
                                    style="color: #bbb; font-family: monospace; white-space: pre-wrap;">Select a namespace to view access graph...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="password-modal" class="modal">
                <div class="modal-content" style="width: 400px;">
                    <h3>Password Required</h3>
                    <p>Enter password to edit YAML:</p>
                    <input type="password" id="password-input"
                        style="width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #444; border-radius: 3px;"
                        onkeypress="if(event.key === 'Enter') checkPassword()">
                    <div id="password-error" style="color: #ff4444; display: none; margin: 10px 0;">Incorrect password
                    </div>
                    <div class="modal-actions" style="justify-content: center;">
                        <button onclick="checkPassword()">Submit</button>
                        <button onclick="closePasswordModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="confirmation-modal" class="modal">
                <div class="modal-content">
                    <h3>Confirm Save</h3>
                    <p>Are you sure you want to save changes to this YAML?</p>
                    <div class="modal-actions" style="justify-content: center;">
                        <button onclick="confirmSave()">Confirm</button>
                        <button onclick="cancelSave()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="deploy-modal" class="modal">
                <div class="modal-content" style="width: 600px;">
                    <span class="close" onclick="closeDeployModal()">&times;</span>
                    <h2>Deploy Image</h2>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Image:</label>
                        <input type="text" id="deploy-image" readonly
                            style="width: 100%; padding: 8px; background: #222; color: #0f0; border: 1px solid #444; font-family: monospace;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Deployment Name:</label>
                        <input type="text" id="deploy-name" placeholder="my-app"
                            style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Namespace:</label>
                        <select id="deploy-namespace"
                            style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444;">
                            <option value="default">default</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Container Port:</label>
                        <input type="number" id="deploy-port" value="80"
                            style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Replicas:</label>
                        <input type="number" id="deploy-replicas" value="1" min="1"
                            style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:5px;">Expose Service:</label>
                        <select id="deploy-expose-type"
                            style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444;">
                            <option value="none">No Service (Internal Only)</option>
                            <option value="clusterip">ClusterIP (Internal)</option>
                            <option value="nodeport">NodePort (External)</option>
                            <option value="loadbalancer">LoadBalancer (Cloud)</option>
                        </select>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            ClusterIP: Internal cluster access only<br>
                            NodePort: Accessible on node IP:port<br>
                            LoadBalancer: Cloud provider load balancer
                        </small>
                    </div>
                    <div class="modal-actions" style="justify-content: center;">
                        <button class="btn-classy primary" onclick="confirmDeploy()">Deploy</button>
                        <button class="btn-classy" onclick="closeDeployModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <script>
                // Password for YAML editing
                const EDIT_PASSWORD = 'h*Q&u+ML8p8;}6$w';

                let currentYamlUrl = '';
                let editor; // CodeMirror instance
                let currentNamespace = 'all'; // Global variable to store the currently selected namespace

                // Initialize CodeMirror when page loads
                window.onload = function () {
                    // Show disclaimer
                    document.getElementById('internet-disclaimer').style.display = 'block';

                    if (typeof CodeMirror !== 'undefined') {
                        // We'll initialize it but keep it empty until needed
                        editor = CodeMirror(document.getElementById('codemirror-container'), {
                            mode: 'yaml',
                            theme: 'monokai',
                            lineNumbers: true,
                            readOnly: true
                        });
                    } else {
                        console.warn('CodeMirror not loaded (Offline?)');
                    }
                };

                function showContent(contentId) {
                    const allContent = document.querySelectorAll('.page-content');
                    allContent.forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(`${contentId}-content`).style.display = 'block';
                }

                function showYamlModal(yaml, url) {
                    const textarea = document.getElementById('yaml-content');
                    const cmContainer = document.getElementById('codemirror-container');
                    const warning = document.getElementById('yaml-editor-warning');

                    if (editor) {
                        // Online Mode
                        textarea.style.display = 'none';
                        cmContainer.style.display = 'block';
                        warning.style.display = 'none';

                        editor.setValue(yaml);
                        editor.setOption('readOnly', true);
                        setTimeout(() => editor.refresh(), 10);
                    } else {
                        // Offline Fallback
                        textarea.style.display = 'block';
                        cmContainer.style.display = 'none';
                        warning.style.display = 'block';
                        textarea.value = yaml;
                        textarea.readOnly = true;
                    }

                    document.getElementById('edit-yaml-btn').style.display = 'inline-block';
                    document.getElementById('save-yaml-btn').style.display = 'none';

                    document.getElementById('yaml-modal').style.display = 'block';
                    document.getElementById('yaml-modal').setAttribute('data-resource-url', url);
                }

                function closeYamlModal() {
                    document.getElementById('yaml-modal').style.display = 'none';
                }

                function enableYamlEditing() {
                    // Show password modal
                    document.getElementById('password-modal').style.display = 'block';
                    document.getElementById('password-input').value = '';
                    document.getElementById('password-error').style.display = 'none';
                    document.getElementById('password-input').focus();
                }

                function closePasswordModal() {
                    document.getElementById('password-modal').style.display = 'none';
                    document.getElementById('password-input').value = '';
                    document.getElementById('password-error').style.display = 'none';
                }

                function checkPassword() {
                    const input = document.getElementById('password-input').value;
                    if (input === EDIT_PASSWORD) {
                        // Correct password - enable editing
                        closePasswordModal();
                        if (editor) {
                            editor.setOption('readOnly', false);
                        } else {
                            document.getElementById('yaml-content').readOnly = false;
                        }
                        document.getElementById('edit-yaml-btn').style.display = 'none';
                        document.getElementById('save-yaml-btn').style.display = 'inline-block';
                    } else {
                        // Wrong password
                        document.getElementById('password-error').style.display = 'block';
                        document.getElementById('password-input').value = '';
                        document.getElementById('password-input').focus();
                    }
                }

                function copyYamlToClipboard() {
                    let yamlContent;
                    if (editor) {
                        yamlContent = editor.getValue();
                    } else {
                        yamlContent = document.getElementById('yaml-content').value;
                    }

                    navigator.clipboard.writeText(yamlContent).then(() => {
                        alert('YAML copied to clipboard!');
                    }, (err) => {
                        console.error('Failed to copy YAML: ', err);
                        alert('Failed to copy YAML. See console for details.');
                    });
                }

                function saveYaml() {
                    document.getElementById('confirmation-modal').style.display = 'block';
                }

                function cancelSave() {
                    document.getElementById('confirmation-modal').style.display = 'none';
                }

                async function confirmSave() {
                    const url = document.getElementById('yaml-modal').getAttribute('data-resource-url');
                    let yamlContent;
                    if (editor) {
                        yamlContent = editor.getValue();
                    } else {
                        yamlContent = document.getElementById('yaml-content').value;
                    }

                    try {
                        const response = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'text/yaml',
                            },
                            body: yamlContent,
                        });
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error);
                        }
                        alert('YAML saved successfully!');
                        document.getElementById('confirmation-modal').style.display = 'none';
                        closeYamlModal();
                        loadAllData();
                    } catch (error) {
                        console.error('Error saving YAML:', error);
                        alert(`Failed to save YAML: ${error.message}`);
                        document.getElementById('confirmation-modal').style.display = 'none';
                    }
                }

                async function fetchAndShowYaml(url) {
                    console.log('Fetching YAML from:', url);
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch YAML from ${url}`);
                        }
                        const yaml = await response.text();
                        showYamlModal(yaml, url);
                    } catch (error) {
                        console.error('Error fetching YAML:', error);
                    }
                }

                async function fetchNamespaces() {
                    try {
                        const response = await fetch('/api/namespaces');
                        if (!response.ok) {
                            throw new Error('Failed to fetch namespaces');
                        }
                        const data = await response.json();
                        const select = document.getElementById('namespace-select');
                        // Clear existing options except the first one
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        data.items.forEach(ns => {
                            const option = document.createElement('option');
                            option.value = ns.metadata.name;
                            option.textContent = ns.metadata.name;
                            select.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching namespaces:', error);
                    }
                }

                function filterByNamespace() {
                    currentNamespace = document.getElementById('namespace-select').value;
                    console.log('Filtering by namespace:', currentNamespace);
                    fetchAndRenderDeployments();
                    fetchAndRenderPods();
                    fetchAndRenderServices();
                    fetchAndRenderIngresses();
                    fetchAndRenderDaemonSets();
                    fetchAndRenderStatefulSets();
                    fetchAndRenderJobs();
                    fetchAndRenderCronJobs();
                    fetchAndRenderConfigMaps();
                    fetchAndRenderSecrets();
                }

                function renderDeployments(items, tableBody) {
                    items.forEach(deployment => {
                        const row = document.createElement('tr');
                        const namespace = deployment.metadata.namespace;
                        const name = deployment.metadata.name;
                        const replicas = deployment.spec.replicas;
                        const readyReplicas = deployment.status.readyReplicas || 0;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${replicas}</td>
                        <td>${readyReplicas}</td>
                        <td><button onclick="fetchAndShowYaml('/api/deployments/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderPods(items, tableBody) {
                    items.forEach(pod => {
                        const row = document.createElement('tr');
                        const namespace = pod.metadata.namespace;
                        const name = pod.metadata.name;
                        const status = pod.status.phase;
                        const node = pod.spec.nodeName;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${status}</td>
                        <td>${node}</td>
                        <td>
                        <button class="btn btn-sm btn-classy" onclick="fetchAndShowYaml('/api/pods/${namespace}/${name}/yaml')">View YAML</button>
                        <button class="btn btn-sm btn-classy" style="margin-left: 5px;" onclick="openLogsModal('${namespace}', '${name}')">View Logs</button>
                    </td>`;
                        tableBody.appendChild(row);
                    });
                }

                function renderServices(items, tableBody) {
                    items.forEach(service => {
                        const row = document.createElement('tr');
                        const namespace = service.metadata.namespace;
                        const name = service.metadata.name;
                        const type = service.spec.type;
                        const clusterIp = service.spec.clusterIP;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${type}</td>
                        <td>${clusterIp}</td>
                        <td><button onclick="fetchAndShowYaml('/api/services/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderIngresses(items, tableBody) {
                    items.forEach(ingress => {
                        const row = document.createElement('tr');
                        const namespace = ingress.metadata.namespace;
                        const name = ingress.metadata.name;
                        const hosts = ingress.spec.rules.map(rule => rule.host).join(', ');
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${hosts}</td>
                        <td><button onclick="fetchAndShowYaml('/api/ingresses/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderDaemonSets(items, tableBody) {
                    items.forEach(daemonset => {
                        const row = document.createElement('tr');
                        const namespace = daemonset.metadata.namespace;
                        const name = daemonset.metadata.name;
                        const desired = daemonset.status.desiredNumberScheduled;
                        const current = daemonset.status.currentNumberScheduled;
                        const ready = daemonset.status.numberReady;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${desired}</td>
                        <td>${current}</td>
                        <td>${ready}</td>
                        <td><button onclick="fetchAndShowYaml('/api/daemonsets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderStatefulSets(items, tableBody) {
                    items.forEach(statefulset => {
                        const row = document.createElement('tr');
                        const namespace = statefulset.metadata.namespace;
                        const name = statefulset.metadata.name;
                        const replicas = statefulset.spec.replicas;
                        const readyReplicas = statefulset.status.readyReplicas || 0;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${replicas}</td>
                        <td>${readyReplicas}</td>
                        <td><button onclick="fetchAndShowYaml('/api/statefulsets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderJobs(items, tableBody) {
                    items.forEach(job => {
                        const row = document.createElement('tr');
                        const namespace = job.metadata.namespace;
                        const name = job.metadata.name;
                        const completions = job.spec.completions;
                        const duration = job.status.completionTime ? new Date(job.status.completionTime) - new Date(job.status.startTime) : '-';
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${completions}</td>
                        <td>${duration}</td>
                        <td><button onclick="fetchAndShowYaml('/api/jobs/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderCronJobs(items, tableBody) {
                    items.forEach(cronjob => {
                        const row = document.createElement('tr');
                        const namespace = cronjob.metadata.namespace;
                        const name = cronjob.metadata.name;
                        const schedule = cronjob.spec.schedule;
                        const lastSchedule = cronjob.status.lastScheduleTime || '-';
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${schedule}</td>
                        <td>${lastSchedule}</td>
                        <td><button onclick="fetchAndShowYaml('/api/cronjobs/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderConfigMaps(items, tableBody) {
                    items.forEach(configmap => {
                        const row = document.createElement('tr');
                        const namespace = configmap.metadata.namespace;
                        const name = configmap.metadata.name;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td><button onclick="fetchAndShowYaml('/api/configmaps/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderSecrets(items, tableBody) {
                    items.forEach(secret => {
                        const row = document.createElement('tr');
                        const namespace = secret.metadata.namespace;
                        const name = secret.metadata.name;
                        const type = secret.type;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${type}</td>
                        <td><button onclick="fetchAndShowYaml('/api/secrets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                async function fetchAndRenderNodes() {
                    try {
                        const response = await fetch('/api/nodes');
                        if (!response.ok) {
                            throw new Error('Failed to fetch nodes');
                        }
                        const data = await response.json();
                        const tableBody = document.querySelector('#nodes-table tbody');
                        tableBody.innerHTML = '';
                        data.items.forEach(node => {
                            const row = document.createElement('tr');
                            const name = node.metadata.name;
                            const status = node.status.conditions.find(c => c.type === 'Ready').status;
                            const version = node.status.nodeInfo.kubeletVersion;
                            row.innerHTML = `
                            <td>${name}</td>
                            <td>${status}</td>
                            <td>${version}</td>
                            <td><button onclick="fetchAndShowYaml('/api/nodes/${name}/yaml')">View YAML</button></td>
                        `;
                            tableBody.appendChild(row);
                        });
                    } catch (error) {
                        console.error('Error fetching nodes:', error);
                    }
                }

                async function fetchAndRenderGeneric(resource, renderFunc, tableBodySelector) {
                    const selectedNamespace = document.getElementById('namespace-select').value;
                    const tableBody = document.querySelector(tableBodySelector);
                    tableBody.innerHTML = '';
                    try {
                        const response = await fetch(`/api/${resource}`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch ${resource}`);
                        }
                        const data = await response.json();
                        const filteredItems = selectedNamespace === 'all'
                            ? data.items
                            : data.items.filter(item => item.metadata.namespace === selectedNamespace);
                        renderFunc(filteredItems, tableBody);
                    } catch (error) {
                        console.error(`Error fetching ${resource}:`, error);
                    }
                }

                function fetchAndRenderDeployments() {
                    fetchAndRenderGeneric('deployments', renderDeployments, '#deployments-table tbody');
                }

                function fetchAndRenderPods() {
                    fetchAndRenderGeneric('pods', renderPods, '#pods-table tbody');
                }

                function fetchAndRenderServices() {
                    fetchAndRenderGeneric('services', renderServices, '#services-table tbody');
                }

                function fetchAndRenderIngresses() {
                    fetchAndRenderGeneric('ingresses', renderIngresses, '#ingresses-table tbody');
                }

                function fetchAndRenderDaemonSets() {
                    fetchAndRenderGeneric('daemonsets', renderDaemonSets, '#daemonsets-table tbody');
                }

                function fetchAndRenderStatefulSets() {
                    fetchAndRenderGeneric('statefulsets', renderStatefulSets, '#statefulsets-table tbody');
                }

                function fetchAndRenderJobs() {
                    fetchAndRenderGeneric('jobs', renderJobs, '#jobs-table tbody');
                }

                function fetchAndRenderCronJobs() {
                    fetchAndRenderGeneric('cronjobs', renderCronJobs, '#cronjobs-table tbody');
                }

                function fetchAndRenderConfigMaps() {
                    fetchAndRenderGeneric('configmaps', renderConfigMaps, '#configmaps-table tbody');
                }

                function fetchAndRenderSecrets() {
                    fetchAndRenderGeneric('secrets', renderSecrets, '#secrets-table tbody');
                }

                let allRepositories = [];

                async function loadRegistryImages() {
                    const list = document.getElementById('registry-list');
                    const errorDiv = document.getElementById('registry-error');
                    const setupDiv = document.getElementById('registry-setup');

                    errorDiv.style.display = 'none';
                    // Don't auto-hide setup here, let user close it or success close it

                    list.innerHTML = '<div style="color: #aaa;">Loading repositories...</div>';

                    try {
                        const res = await fetch('/api/repositories');
                        if (!res.ok) {
                            const errData = await res.json();
                            const errMsg = errData.details?.message || errData.error || 'Unknown error';

                            // Check for configuration error
                            if (errMsg.includes('pass the domain') || errMsg.includes('reg command not found')) {
                                document.getElementById('registry-error-msg').innerText = "Please configure your Registry details.";
                                errorDiv.style.backgroundColor = '#332b00'; // Warning color instead of red
                                errorDiv.style.borderColor = '#ffcc00';
                                errorDiv.style.color = '#ffffcc';
                            } else {
                                document.getElementById('registry-error-msg').innerText = errMsg;
                                errorDiv.style.backgroundColor = '#330000';
                                errorDiv.style.borderColor = '#ff4444';
                                errorDiv.style.color = '#ffcccc';
                            }

                            errorDiv.style.display = 'block';
                            list.innerHTML = '';

                            // Show setup if it's a connection/config error
                            setupDiv.style.display = 'block';
                            return;
                        }

                        // Handle 200 OK
                        allRepositories = await res.json();
                        renderRepositories();
                        // If successful, we can hide setup/error
                        setupDiv.style.display = 'none';
                        errorDiv.style.display = 'none';

                    } catch (e) {
                        list.innerHTML = '';
                        document.getElementById('registry-error-msg').innerText = e.message;
                        errorDiv.style.display = 'block';
                        setupDiv.style.display = 'block';
                    }
                }

                // Alias for initial load
                const fetchRepositories = loadRegistryImages;

                function renderRepositories(filterText = '') {
                    const container = document.getElementById('registry-list');
                    container.innerHTML = '';

                    const filtered = allRepositories.filter(r => r.includes(filterText));

                    if (filtered.length === 0) {
                        container.innerHTML = '<div style="color: #aaa;">No repositories found.</div>';
                        return;
                    }

                    filtered.forEach(repo => {
                        const item = document.createElement('div');
                        item.className = 'repo-item';
                        item.style.border = '1px solid #444';
                        item.style.borderRadius = '5px';
                        item.style.background = '#2a2a2a';
                        item.style.overflow = 'hidden';

                        // Header
                        const header = document.createElement('div');
                        header.style.padding = '15px';
                        header.style.cursor = 'pointer';
                        header.style.display = 'flex';
                        header.style.justifyContent = 'space-between';
                        header.style.alignItems = 'center';
                        header.style.background = '#333';
                        header.innerHTML = `<strong>${repo}</strong> <span style="color: #888;"></span>`;

                        header.onclick = () => toggleRepoTags(repo, item);

                        // Tags Container (Hidden by default)
                        const tagsContainer = document.createElement('div');
                        tagsContainer.id = `tags-${repo}`;
                        tagsContainer.style.display = 'none';
                        tagsContainer.style.padding = '10px';
                        tagsContainer.style.background = '#222';
                        tagsContainer.innerHTML = '<div style="color: #888; font-style: italic;">Loading tags...</div>';

                        item.appendChild(header);
                        item.appendChild(tagsContainer);
                        container.appendChild(item);
                    });
                }

                function filterRepositories() {
                    const text = document.getElementById('repo-search').value;
                    renderRepositories(text);
                }

                async function toggleRepoTags(repo, itemElement) {
                    const tagsDiv = document.getElementById(`tags-${repo}`);
                    const isExpanded = tagsDiv.style.display === 'block';

                    // Toggle visibility
                    tagsDiv.style.display = isExpanded ? 'none' : 'block';

                    // Rotate arrow
                    const arrow = itemElement.querySelector('span');
                    arrow.innerHTML = isExpanded ? '' : '';

                    if (!isExpanded && !tagsDiv.dataset.loaded) {
                        // Fetch if opening and not loaded
                        try {
                            const res = await fetch(`/api/repositories/${repo}/tags`);
                            const data = await res.json();

                            if (data.tags.length === 0) {
                                tagsDiv.innerHTML = '<div style="padding: 5px; color: #888;">No tags found.</div>';
                            } else {
                                const tz = document.getElementById('registry-timezone').value || 'UTC';
                                let html = '<select style="width: 100%; padding: 10px; background: #111; color: #0f0; border: 1px solid #444; font-family: monospace;">';
                                data.tags.forEach(t => {
                                    let dateStr = 'Unknown';
                                    try {
                                        if (t.created && new Date(t.created).getTime() > 0) {
                                            dateStr = new Date(t.created).toLocaleString('en-US', { timeZone: tz });
                                        } else {
                                            dateStr = 'Date unavailable';
                                        }
                                    } catch (e) { dateStr = 'Invalid Date'; }

                                    const tagName = t.name;
                                    html += `<option value="${tagName}">${tagName} (Pushed: ${dateStr})</option>`;
                                });
                                html += '</select>';
                                html += `<button class="btn btn-classy" style="margin-top: 10px; width: 100%;" onclick="openDeployModal('${repo}')">Deploy Selected Tag</button>`;
                                tagsDiv.innerHTML = html;
                            }
                            tagsDiv.dataset.loaded = 'true';
                        } catch (e) {
                            tagsDiv.innerHTML = `<div style="color: red;">Error loading tags: ${e.message}</div>`;
                        }
                    }
                }

                async function saveRegistryConfig() {
                    const url = document.getElementById('registry-url').value;
                    const username = document.getElementById('registry-username').value;
                    const password = document.getElementById('registry-password').value;
                    const isSecure = document.getElementById('registry-secure').checked;
                    const timezone = document.getElementById('registry-timezone').value;

                    try {
                        const response = await fetch('/api/config/registry', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url, username, password, isSecure, timezone })
                        });
                        if (response.ok) {
                            alert('Configuration saved!');
                            fetchRepositories();
                        } else {
                            alert('Failed to save configuration');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Error saving configuration');
                    }
                }

                async function loadRegistryConfig() {
                    try {
                        const res = await fetch('/api/config/registry');
                        if (res.ok) {
                            const data = await res.json();
                            if (data.url) {
                                document.getElementById('registry-url').value = data.url;
                            }
                            if (data.username) {
                                document.getElementById('registry-username').value = data.username;
                            }
                            if (data.isSecure !== undefined) {
                                document.getElementById('registry-secure').checked = data.isSecure;
                            } else {
                                document.getElementById('registry-secure').checked = false; // Default off
                            }
                            if (data.timezone) {
                                document.getElementById('registry-timezone').value = data.timezone;
                            }
                            // Don't autofill password for security/UX reasons, or could if desired.
                            // Leaving blank for now.
                        }
                    } catch (e) { console.error(e); }
                }

                function openDeployModal(repo) {
                    // Get selected tag from the dropdown
                    const tagsDiv = document.getElementById(`tags-${repo}`);
                    const select = tagsDiv.querySelector('select');
                    if (!select || !select.value) {
                        alert('Please select a tag first');
                        return;
                    }

                    const tag = select.value;
                    const registryUrl = document.getElementById('registry-url').value || 'localhost:5000';
                    const fullImage = `${registryUrl}/${repo}:${tag}`;

                    // Populate modal
                    document.getElementById('deploy-image').value = fullImage;
                    document.getElementById('deploy-name').value = repo.replace(/[^a-z0-9-]/g, '-').toLowerCase();

                    // Populate namespace dropdown
                    populateDeployNamespaces();

                    // Show modal
                    document.getElementById('deploy-modal').style.display = 'block';
                }

                function closeDeployModal() {
                    document.getElementById('deploy-modal').style.display = 'none';
                }

                async function populateDeployNamespaces() {
                    try {
                        const res = await fetch('/api/namespaces');
                        if (res.ok) {
                            const data = await res.json();
                            const select = document.getElementById('deploy-namespace');
                            select.innerHTML = '';
                            data.items.forEach(ns => {
                                const opt = document.createElement('option');
                                opt.value = ns.metadata.name;
                                opt.textContent = ns.metadata.name;
                                select.appendChild(opt);
                            });
                        }
                    } catch (e) {
                        console.error('Error loading namespaces:', e);
                    }
                }

                async function confirmDeploy() {
                    const image = document.getElementById('deploy-image').value;
                    const name = document.getElementById('deploy-name').value;
                    const namespace = document.getElementById('deploy-namespace').value;
                    const port = parseInt(document.getElementById('deploy-port').value);
                    const replicas = parseInt(document.getElementById('deploy-replicas').value);
                    const exposeType = document.getElementById('deploy-expose-type').value;

                    if (!name) {
                        alert('Please enter a deployment name');
                        return;
                    }

                    try {
                        const response = await fetch('/api/deployments/deploy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image, name, namespace, port, replicas, exposeType })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(result.message || 'Deployment successful!');
                            closeDeployModal();
                            // Refresh deployments if on that page
                            if (document.getElementById('deployments-content').style.display !== 'none') {
                                fetchAndRenderDeployments();
                            }
                        } else {
                            const error = await response.json();
                            alert(`Deployment failed: ${error.error || 'Unknown error'}`);
                        }
                    } catch (e) {
                        console.error('Deploy error:', e);
                        alert(`Error: ${e.message}`);
                    }
                }

                async function loadAllData() {
                    document.getElementById('welcome-message') && (document.getElementById('welcome-message').style.display = 'none');
                    try {
                        await Promise.all([
                            fetchNamespaces(),
                            fetchAndRenderNodes(),
                            fetchAndRenderDeployments(),
                            fetchAndRenderPods(),
                            fetchAndRenderServices(),
                            fetchAndRenderIngresses(),
                            fetchAndRenderDaemonSets(),
                            fetchAndRenderStatefulSets(),
                            fetchAndRenderJobs(),
                            fetchAndRenderCronJobs(),
                            fetchAndRenderConfigMaps(),
                            fetchAndRenderSecrets(),
                            loadRegistryConfig(),
                            fetchRepositories()
                        ]);
                        filterByNamespace();
                    } catch (e) {
                        console.error('Error loading initial data', e);
                        alert('Error loading initial data: ' + e.message);
                    }
                }

                async function loadContexts() {
                    try {
                        const res = await fetch('/api/contexts');
                        const data = await res.json();
                        const selector = document.getElementById('context-selector');
                        selector.innerHTML = '';

                        if (data.contexts && Array.isArray(data.contexts)) {
                            data.contexts.forEach(ctx => {
                                const opt = document.createElement('option');
                                opt.value = ctx;
                                opt.textContent = ctx;
                                if (ctx === data.currentContext) {
                                    opt.selected = true;
                                }
                                selector.appendChild(opt);
                            });
                        }
                    } catch (err) {
                        console.error('Failed to load contexts', err);
                    }
                }

                async function switchContext(contextName) {
                    try {
                        const res = await fetch('/api/contexts/current', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ context: contextName })
                        });
                        if (res.ok) {
                            loadAllData();
                        } else {
                            alert('Failed to switch context');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error switching context');
                    }
                }

                // Network Map Logic
                async function showNetworkMap() {
                    document.getElementById('network-map-modal').style.display = 'block';

                    // Populate namespace selector in modal (clone from main or fetch)
                    const mainNsSelect = document.getElementById('namespace-select');
                    const mapNsSelect = document.getElementById('map-namespace-select');

                    // Preserve selection if possible, else copy all
                    const currentVal = mapNsSelect.value;
                    mapNsSelect.innerHTML = mainNsSelect.innerHTML;
                    // Add 'All Namespaces' if removed or just ensure it's there
                    // The main selector might not have 'all' if it's strict. Let's force it.
                    // Actually main selector logic is: <option value="all">All Namespaces</option> + others.
                    if (mainNsSelect.value) mapNsSelect.value = mainNsSelect.value;

                    // Check Otterize Status to toggle Install Button
                    try {
                        const res = await fetch('/api/otterize/status');
                        const status = await res.json();
                        const installBtn = document.getElementById('btn-install-otterize');
                        if (status.installed) {
                            installBtn.style.display = 'none';
                        } else {
                            installBtn.style.display = 'block';
                        }
                    } catch (e) {
                        console.error('Failed to check otterize status', e);
                    }

                    renderNetworkMap();
                }

                function closeNetworkMap() {
                    document.getElementById('network-map-modal').style.display = 'none';
                }

                async function renderNetworkMap() {
                    const container = document.getElementById('network-map-container');
                    const namespace = document.getElementById('map-namespace-select').value;
                    const accessGraphText = document.getElementById('access-graph-text');

                    // Fallback for offline usage
                    if (typeof vis === 'undefined') {
                        container.innerHTML = '<div style="color:orange; padding:20px; text-align:center;"><h3>Network Map Unavailable</h3><p>Vis.js library failed to load (Offline?). Internet access is required for this feature.</p></div>';
                        return;
                    }

                    container.innerHTML = '<div style="color:white; padding:20px;">Loading map data...</div>';
                    accessGraphText.textContent = 'Loading...';

                    try {
                        const res = await fetch(`/api/network-map?namespace=${namespace}`);
                        if (!res.ok) throw new Error('Failed to fetch map data');
                        const data = await res.json();

                        if (data.edges.length === 0) {
                            // Check if users might need to install otterize
                            // Only show instructions if NOT installed
                            const installBtn = document.getElementById('btn-install-otterize');
                            if (installBtn.style.display !== 'none') {
                                document.getElementById('otterize-instructions').style.display = 'block';
                            } else {
                                document.getElementById('otterize-instructions').style.display = 'none';
                            }
                        } else {
                            document.getElementById('otterize-instructions').style.display = 'none';
                        }

                        // Render Textual Graph (CLI Simulation)
                        renderAccessList(data);

                        // Create Vis.js data
                        const nodes = new vis.DataSet(data.nodes);
                        const edges = new vis.DataSet(data.edges);

                        const mapData = { nodes: nodes, edges: edges };
                        const options = {
                            nodes: {
                                shape: 'box',
                                margin: 10,
                                font: { color: 'black' },
                                color: { background: '#2196F3', border: '#0D47A1' }
                            },
                            edges: {
                                arrows: {
                                    to: {
                                        enabled: true,
                                        scaleFactor: 1.2
                                    }
                                },
                                color: {
                                    color: '#ffffff',
                                    highlight: '#ff9800', // Orange on click
                                    hover: '#ff9800',
                                    inherit: false,
                                    opacity: 1.0
                                },
                                width: 2,
                                smooth: {
                                    type: 'continuous'
                                }
                            },
                            physics: {
                                enabled: true,
                                barnesHut: {
                                    gravitationalConstant: -4000,
                                    centralGravity: 0.1,
                                    springLength: 250,
                                    springConstant: 0.04,
                                    damping: 0.09,
                                    avoidOverlap: 1
                                },
                            },
                            layout: {
                                randomSeed: 2
                            }
                            // layout: {
                            //     hierarchical: {
                            //         direction: 'LR', // Left to Right
                            //         sortMethod: 'directed',
                            //         levelSeparation: 150,
                            //         nodeSpacing: 100,
                            //         treeSpacing: 200
                            //     }
                            // }
                        };

                        new vis.Network(container, mapData, options);

                    } catch (err) {
                        console.error(err);
                        container.innerHTML = `<div style="color:red; padding:20px;">Error loading map: ${err.message}</div>`;
                        accessGraphText.textContent = 'Error loading data.';
                    }
                }

                function renderAccessList(data) {
                    // data.nodes = [{id, label, group...}]
                    // data.edges = [{from, to...}]

                    // Guidance for empty state
                    if (data.edges.length === 0) {
                        document.getElementById('access-graph-text').innerHTML = `
<div style="color: #ccc; padding: 10px;">
    <strong>No Traffic Detected</strong>
    <p>The network map shows <em>active traffic</em> between services.</p>
    <p><strong>To populate the map:</strong></p>
    <ol style="padding-left: 20px; line-height: 1.6;">
        <li>Ensure Otterize is installed (Status: <span id="ott-status-txt">Checking...</span>).</li>
        <li><strong>Generate Traffic:</strong> Interact with your applications (e.g., make HTTP requests, trigger jobs).</li>
        <li>Wait 30-60 seconds for the mapper to aggregate data.</li>
        <li>Click <strong>Refresh Map</strong>.</li>
    </ol>
</div>`;
                        // Check status for the help text
                        fetch('/api/otterize/status').then(r => r.json()).then(s => {
                            const el = document.getElementById('ott-status-txt');
                            if (el) el.textContent = s.installed ? 'Installed ' : 'Not Installed ';
                            if (el) el.style.color = s.installed ? 'lightgreen' : 'red';
                        });

                        return;
                    }

                    // Group edges by source
                    const map = {}; // sourceID -> [targetIDs]

                    data.nodes.forEach(n => {
                        map[n.id] = { name: n.label, ns: n.group, calls: [] };
                    });

                    data.edges.forEach(e => {
                        if (map[e.from]) {
                            // Resolve target name
                            const targetNode = data.nodes.find(n => n.id === e.to);
                            const targetName = targetNode ? targetNode.label : e.to;
                            if (!map[e.from].calls.includes(targetName)) {
                                map[e.from].calls.push(targetName);
                            }
                        }
                    });

                    let output = '';
                    // Format:
                    // frontend in namespace otterize-ecom-demo calls:
                    //   - cartservice

                    Object.values(map).forEach(item => {
                        if (item.calls.length > 0) {
                            output += `${item.name} in namespace ${item.ns} calls:\n`;
                            item.calls.sort().forEach(target => {
                                output += `  - ${target}\n`;
                            });
                            output += '\n';
                        }
                    });

                    document.getElementById('access-graph-text').textContent = output;
                }

                async function installOtterize() {
                    try {
                        const res = await fetch('/api/otterize/install', { method: 'POST' });
                        const data = await res.json();
                        alert(data.message);
                        document.getElementById('otterize-instructions').style.display = 'block';
                    } catch (err) {
                        alert('Failed to start installation: ' + err.message);
                    }
                }

                // --- Create Resource Logic ---
                let createEditor;

                function openCreateModal() {
                    document.getElementById('create-resource-modal').style.display = 'block';

                    // Init editor if needed
                    if (!createEditor) {
                        const container = document.getElementById('create-editor-container');
                        if (typeof CodeMirror !== 'undefined') {
                            createEditor = CodeMirror(container, {
                                mode: 'yaml',
                                theme: 'monokai',
                                lineNumbers: true,
                                tabSize: 2
                            });
                        } else {
                            container.innerHTML = '<textarea id="create-fallback-textarea" style="width:100%; height:100%; background:#222; color:white;"></textarea>';
                        }
                    }

                    // Reset
                    document.getElementById('create-mode-select').value = 'template';
                    toggleCreateMode();

                    // Populate namespaces for clone AND target
                    const mainNs = document.getElementById('namespace-select');
                    const cloneNs = document.getElementById('clone-ns-select');
                    const targetNs = document.getElementById('create-target-ns');

                    cloneNs.innerHTML = mainNs.innerHTML;
                    if (cloneNs.querySelector('option[value="all"]')) cloneNs.querySelector('option[value="all"]').remove();

                    targetNs.innerHTML = '<option value="">Use YAML / Default</option>' + mainNs.innerHTML;
                    // Remove 'All Namespaces' from target if present (usually strictly 'all' isn't valid for creation)
                    const allOpt = targetNs.querySelector('option[value="all"]');
                    if (allOpt) allOpt.remove();

                    // Select current namespace if valid
                    if (currentNamespace && currentNamespace !== 'all') {
                        targetNs.value = currentNamespace;
                    }
                }

                function closeCreateModal() {
                    document.getElementById('create-resource-modal').style.display = 'none';
                }

                function getCreateYaml() {
                    if (createEditor) return createEditor.getValue();
                    const ta = document.getElementById('create-fallback-textarea');
                    return ta ? ta.value : '';
                }

                function setCreateYaml(val) {
                    if (createEditor) createEditor.setValue(val);
                    const ta = document.getElementById('create-fallback-textarea');
                    if (ta) ta.value = val;
                }

                function toggleCreateMode() {
                    const mode = document.getElementById('create-mode-select').value;
                    document.getElementById('create-template-options').style.display = mode === 'template' ? 'block' : 'none';
                    document.getElementById('create-clone-options').style.display = mode === 'clone' ? 'block' : 'none';
                    setCreateYaml('# Select a template or resource to start...');
                }

                const TEMPLATES = {
                    deployment: `apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-container
        image: nginx:latest
        ports:
        - containerPort: 80`,
                    service: `apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP`,
                    pvc: `apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi`,
                    configmap: `apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
  namespace: default
data:
  config.yaml: |
    key: value`,
                    secret: `apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  namespace: default
type: Opaque
stringData:
  username: admin
  password: changeit`,
                    ingress: `apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  namespace: default
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-service
            port:
              number: 80`
                };

                function loadTemplate() {
                    const type = document.getElementById('template-type-select').value;
                    if (TEMPLATES[type]) {
                        setCreateYaml(TEMPLATES[type]);
                        updateYamlNamespace(); // Sync with currently selected target NS
                    }
                }

                async function loadCloneResources() {
                    const ns = document.getElementById('clone-ns-select').value;
                    // Mapped to API endpoints. 
                    // Need logic to fetch list similar to main view but raw names.
                    // Re-using existing endpoints?
                    // api/deployments etc return list.
                    const type = document.getElementById('clone-type-select').value;
                    const resSelect = document.getElementById('clone-resource-select');
                    resSelect.innerHTML = '<option>Loading...</option>';

                    try {
                        const res = await fetch(`/api/${type}`); // e.g. /api/deployments
                        const data = await res.json();
                        // Filter by namespace
                        const items = data.items.filter(i => i.metadata.namespace === ns);

                        resSelect.innerHTML = '<option value="">Select...</option>';
                        items.forEach(i => {
                            const opt = document.createElement('option');
                            opt.value = i.metadata.name;
                            opt.innerText = i.metadata.name;
                            resSelect.appendChild(opt);
                        });
                    } catch (e) {
                        console.error(e);
                        resSelect.innerHTML = '<option>Error loading</option>';
                    }
                }

                async function fetchCloneYaml() {
                    const ns = document.getElementById('clone-ns-select').value;
                    const typePlural = document.getElementById('clone-type-select').value;
                    const name = document.getElementById('clone-resource-select').value;
                    if (!name) return;

                    // Need singular type for yaml endpoint: /api/deployments/:ns/:name/yaml
                    // Wait, existing endpoints are specific.
                    // api/deployments/:ns/:name/yaml works. 
                    // api/services/:ns/:name/yaml works.
                    // Let's use the one consistent endpoint structure:

                    try {
                        const res = await fetch(`/api/${typePlural}/${ns}/${name}/yaml`);
                        let text = await res.text();

                        // Strip specific metadata to make it cloneable
                        // Simple regex or just dump as is and user edits
                        setCreateYaml(text);
                        updateYamlNamespace(); // Sync with currently selected target NS
                    } catch (e) {
                        alert('Failed to load YAML');
                    }
                }

                function updateYamlNamespace() {
                    const targetNs = document.getElementById('create-target-ns').value;
                    if (!targetNs) return;

                    let yaml = getCreateYaml();
                    if (!yaml) return;

                    // Match "namespace: value" inside metadata logic tentatively
                    // We assume standard indentation (2 spaces) for metadata children usually.

                    if (yaml.match(/^\s*namespace:\s*.+$/m)) {
                        // Replace existing namespace line
                        yaml = yaml.replace(/(^\s*namespace:\s*)(.+)$/m, `$1${targetNs}`);
                    } else {
                        // If namespace doesn't exist, try to inject it under metadata
                        if (yaml.match(/^\s*metadata:\s*$/m)) {
                            yaml = yaml.replace(/(^\s*metadata:\s*$)/m, `$1\n  namespace: ${targetNs}`);
                        }
                    }
                    setCreateYaml(yaml);
                }

                async function applyResource() {
                    const yamlContent = getCreateYaml();
                    const targetNs = document.getElementById('create-target-ns').value;
                    if (!yamlContent) return;

                    if (!confirm(`Apply this configuration to the cluster?${targetNs ? ` (Namespace: ${targetNs})` : ''}`)) return;

                    try {
                        const res = await fetch('/api/resources/apply', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                yaml: yamlContent,
                                context: document.getElementById('context-selector').value,
                                namespace: targetNs
                            })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert('Resource Created/Applied Successfully!\n' + data.output);
                            closeCreateModal();
                            loadAllData(); // Refresh lists
                        } else {
                            alert('Failed: ' + data.details);
                        }
                    } catch (e) {
                        alert('Error applying resource: ' + e.message);
                    }
                }


                // Initialize
                loadContexts().then(() => {
                    // Default view
                    showContent('nodes');
                    loadAllData();
                });
            </script>
            <!-- Logs Modal -->
            <div id="logs-modal" class="modal">
                <div class="modal-content"
                    style="width: 80%; max-width: 1000px; height: 80vh; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>Pod Logs: <span id="logs-pod-name"></span></h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em;">
                                <input type="checkbox" id="logs-auto-refresh"> Auto-refresh (3s)
                            </label>
                            <span class="close" onclick="closeLogsModal()">&times;</span>
                        </div>
                    </div>
                    <div id="logs-container"
                        style="flex-grow: 1; overflow: hidden; background: #1e1e1e; border-radius: 4px; border: 1px solid #333;">
                        <pre id="logs-content"
                            style="margin: 0; padding: 15px; width: 100%; height: 100%; overflow: auto; color: #00ff00; font-family: 'Courier New', Courier, monospace; font-size: 14px; white-space: pre-wrap; box-sizing: border-box;"></pre>
                    </div>
                </div>
            </div>

            <script>
                let logsInterval = null;
                let currentLogPod = null;
                let currentLogNamespace = null;

                function openLogsModal(namespace, name) {
                    currentLogPod = name;
                    currentLogNamespace = namespace;
                    document.getElementById('logs-pod-name').innerText = name;
                    document.getElementById('logs-content').innerText = 'Loading logs...';
                    document.getElementById('logs-modal').style.display = 'block';

                    document.getElementById('logs-auto-refresh').checked = false; // Default off
                    if (logsInterval) clearInterval(logsInterval);

                    fetchPodLogs();

                    // Checkbox listener
                    document.getElementById('logs-auto-refresh').onchange = (e) => {
                        if (e.target.checked) {
                            fetchPodLogs(); // Fetch immediately
                            logsInterval = setInterval(fetchPodLogs, 3000);
                        } else {
                            clearInterval(logsInterval);
                        }
                    };
                }

                function closeLogsModal() {
                    document.getElementById('logs-modal').style.display = 'none';
                    if (logsInterval) clearInterval(logsInterval);
                    currentLogPod = null;
                    currentLogNamespace = null;
                }

                async function fetchPodLogs() {
                    if (!currentLogPod || !currentLogNamespace) return;

                    try {
                        const context = document.getElementById('context-selector').value; // Use global selector
                        const res = await fetch(`/api/pods/${currentLogNamespace}/${currentLogPod}/logs?tail=200`, {
                            headers: { 'x-k8s-context': context }
                        });

                        if (res.ok) {
                            const text = await res.text();
                            const logsContent = document.getElementById('logs-content');
                            const wasAtBottom = logsContent.scrollHeight - logsContent.scrollTop === logsContent.clientHeight;

                            logsContent.innerText = text || 'No logs found.';

                            if (wasAtBottom) {
                                logsContent.scrollTop = logsContent.scrollHeight;
                            }
                        } else {
                            document.getElementById('logs-content').innerText = 'Failed to load logs.';
                        }
                    } catch (err) {
                        console.error('Error fetching logs:', err);
                        document.getElementById('logs-content').innerText = 'Error fetching logs.';
                    }
                }

                // Close modal if clicking outside
                window.onclick = function (event) {
                    const createModal = document.getElementById('create-resource-modal');
                    const logsModal = document.getElementById('logs-modal');
                    if (event.target == createModal) {
                        closeCreateModal();
                    }
                    if (event.target == logsModal) {
                        closeLogsModal();
                    }
                }
            </script>

            <!-- Footer -->
            <footer style="text-align: center; padding: 20px; color: #666; font-size: 0.9em; margin-top: auto;">
                Made with &lt;3 by @imranfosec
            </footer>
</body>

</html>