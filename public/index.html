<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k3s Suite</title>
    <link rel="stylesheet" href="style.css">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
    <style>
        .CodeMirror {
            height: 100%;
            font-size: 14px;
            border: 1px solid #444;
        }

        #network-map-container {
            width: 100%;
            height: 600px;
            border: 1px solid #444;
            background: #222;
        }
    </style>
    <!-- Vis.js -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Internet Access Disclaimer -->
    <div id="internet-disclaimer"
        style="background: #ff9800; color: #000; padding: 10px; text-align: center; display: none;">
        <strong>Notice:</strong> This application uses external libraries (CodeMirror, Vis.js) which require internet
        access. In air-gapped environments, the YAML Editor and Network Map may be unavailable.
        <button
            onclick="document.getElementById('internet-disclaimer').style.removeProperty('display'); document.getElementById('internet-disclaimer').style.display = 'none';"
            style="background:none; border:none; cursor:pointer; font-weight:bold; margin-left:10px;">[Dismiss]</button>
    </div>

    <div class="container">
        <header
            style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #1f1f1f; border-bottom: 1px solid #444;">
            <h1 style="margin: 0; font-size: 1.5em; color: white;">k3s Suite</h1>
            <button onclick="showNetworkMap()" class="btn-classy">
                View Cluster Map
            </button>
        </header>
        <div id="sidebar">

            <div style="padding: 10px; border-bottom: 1px solid #444;">
                <label for="context-selector"
                    style="display:block; margin-bottom:5px; font-size:0.9em; color:#aaa;">Cluster / Context:</label>
                <select id="context-selector"
                    style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 3px;"
                    onchange="switchContext(this.value)">
                    <option>Loading...</option>
                </select>
            </div>
            <div class="content">
                <div class="sidebar">
                    <button onclick="showContent('nodes')">Nodes</button>
                    <button onclick="showContent('deployments')">Deployments</button>
                    <button onclick="showContent('pods')">Pods</button>
                    <button onclick="showContent('services')">Services</button>
                    <button onclick="showContent('ingresses')">Ingresses</button>
                    <button onclick="showContent('daemonsets')">DaemonSets</button>
                    <button onclick="showContent('statefulsets')">StatefulSets</button>
                    <button onclick="showContent('jobs')">Jobs</button>
                    <button onclick="showContent('cronjobs')">CronJobs</button>
                    <button onclick="showContent('configmaps')">ConfigMaps</button>
                    <button onclick="showContent('secrets')">Secrets</button>
                    <button onclick="showContent('repositories')">Repositories</button>
                </div>
                <div class="main-content">
                    <div class="namespace-filter">
                        <label for="namespace-select">Namespace:</label>
                        <select id="namespace-select" onchange="filterByNamespace()">
                            <option value="all">All Namespaces</option>
                        </select>
                    </div>
                    <div id="nodes-content" class="page-content">
                        <div class="page-header">
                            <h2>Nodes</h2>
                            <button onclick="fetchAndRenderNodes()">Refresh</button>
                        </div>
                        <table id="nodes-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Version</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="deployments-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Deployments</h2>
                            <button onclick="fetchAndRenderDeployments()">Refresh</button>
                        </div>
                        <table id="deployments-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Replicas</th>
                                    <th>Ready Replicas</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="pods-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Pods</h2>
                            <button onclick="fetchAndRenderPods()">Refresh</button>
                        </div>
                        <table id="pods-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Node</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="services-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Services</h2>
                            <button onclick="fetchAndRenderServices()">Refresh</button>
                        </div>
                        <table id="services-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Cluster IP</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="ingresses-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Ingresses</h2>
                            <button onclick="fetchAndRenderIngresses()">Refresh</button>
                        </div>
                        <table id="ingresses-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Hosts</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="daemonsets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>DaemonSets</h2>
                            <button onclick="fetchAndRenderDaemonSets()">Refresh</button>
                        </div>
                        <table id="daemonsets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Desired</th>
                                    <th>Current</th>
                                    <th>Ready</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="statefulsets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>StatefulSets</h2>
                            <button onclick="fetchAndRenderStatefulSets()">Refresh</button>
                        </div>
                        <table id="statefulsets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Replicas</th>
                                    <th>Ready Replicas</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="jobs-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Jobs</h2>
                            <button onclick="fetchAndRenderJobs()">Refresh</button>
                        </div>
                        <table id="jobs-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Completions</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="cronjobs-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>CronJobs</h2>
                            <button onclick="fetchAndRenderCronJobs()">Refresh</button>
                        </div>
                        <table id="cronjobs-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Schedule</th>
                                    <th>Last Schedule</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="configmaps-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>ConfigMaps</h2>
                            <button onclick="fetchAndRenderConfigMaps()">Refresh</button>
                        </div>
                        <table id="configmaps-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="secrets-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Secrets</h2>
                            <button onclick="fetchAndRenderSecrets()">Refresh</button>
                        </div>
                        <table id="secrets-table">
                            <thead>
                                <tr>
                                    <th>Namespace</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div id="repositories-content" class="page-content" style="display: none;">
                        <div class="page-header">
                            <h2>Repositories</h2>
                        </div>
                        <div id="registry-setup"
                            style="display: none; padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px;">
                            <h3>Registry Setup</h3>
                            <p>Configure your local Docker Registry.</p>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-url" style="display:block; margin-bottom:5px;">Registry URL (e.g.
                                    localhost:5000):</label>
                                <input type="text" id="registry-url" placeholder="localhost:5000"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-username" style="display:block; margin-bottom:5px;">Username
                                    (Optional):</label>
                                <input type="text" id="registry-username" placeholder="Username"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="registry-password" style="display:block; margin-bottom:5px;">Password
                                    (Optional):</label>
                                <input type="password" id="registry-password" placeholder="Password"
                                    style="padding: 0.5em; width: 300px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <input type="checkbox" id="registry-secure">
                                <label for="registry-secure">Use Secure Connection (SSL)</label>
                            </div>
                            <button onclick="saveRegistryConfig()">Save Configuration</button>
                        </div>
                        <div id="registry-error"
                            style="display: none; padding: 20px; background-color: #330000; border: 1px solid #ff4444; border-radius: 5px; margin-bottom: 20px; color: #ffcccc;">
                            <h3 style="margin-top: 0;">Error</h3>
                            <p id="registry-error-msg"></p>
                            <div id="reg-install-instructions"
                                style="display: none; margin-top: 10px; background-color: #1a0000; padding: 10px; border-radius: 3px; font-family: monospace;">
                                <p>To view repositories, you need to install the 'reg' tool.</p>
                                <p><strong>Mac (Homebrew):</strong><br>brew install reg</p>
                                <p><strong>Linux:</strong><br>curl -jfL
                                    https://github.com/genuinetools/reg/releases/download/v0.16.1/reg-linux-amd64 -o
                                    /usr/local/bin/reg && chmod +x /usr/local/bin/reg</p>
                            </div>
                            <div id="docker-insecure-instructions"
                                style="display: none; margin-top: 10px; background-color: #1a0000; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap;">
                                <strong style="color: #ffaa00;">ðŸ’¡ Likely Solution: Docker's Insecure Registries
                                    Configuration</strong>

                                The most common reason for this behavior is that the Docker Daemon enforces HTTPS. You
                                need
                                to tell Docker that your registry (e.g., localhost:8090) is an insecure (HTTP) registry.

                                1. <strong>Locate/Create daemon.json</strong>:
                                Linux: <code>/etc/docker/daemon.json</code>
                                Windows: <code>C:\ProgramData\Docker\config\daemon.json</code>
                                macOS: Docker Desktop > Settings > Docker Engine

                                2. <strong>Add the insecure-registries Entry</strong>:
                                <code>{
      "insecure-registries": ["YOUR_REGISTRY_URL"]
    }</code>

                                3. <strong>Restart Docker Daemon</strong>:
                                Linux: <code>sudo systemctl restart docker</code>
                                Mac/Windows: Restart Docker Desktop.
                            </div>
                        </div>
                        <button onclick="fetchRepositories()" style="margin-bottom: 1em;">Refresh</button>
                        <ul id="repositories-list"></ul>
                    </div>
                </div>
            </div>

            <!-- Create Resource Button (FAB) -->
            <button class="fab" onclick="openCreateModal()" title="Create Resource">
                +
                <span class="fab-tooltip">Create Resource</span>
            </button>

            <div id="create-resource-modal" class="modal">
                <div class="modal-content" style="width: 80%; max-width: 800px;">
                    <span class="close" onclick="closeCreateModal()">&times;</span>
                    <h2>Create Resource</h2>

                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label>Start From:</label>
                            <select id="create-mode-select" onchange="toggleCreateMode()">
                                <option value="template">New from Template</option>
                                <option value="clone">Clone Existing Resource</option>
                            </select>
                        </div>
                    </div>

                    <!-- Template Options -->
                    <div id="create-template-options" style="display: block; margin-bottom: 15px;">
                        <label>Resource Type:</label>
                        <select id="template-type-select" onchange="loadTemplate()">
                            <option value="">Select a type...</option>
                            <option value="deployment">Deployment</option>
                            <option value="service">Service</option>
                            <option value="pvc">PersistentVolumeClaim</option>
                            <option value="configmap">ConfigMap</option>
                            <option value="secret">Secret</option>
                            <option value="ingress">Ingress</option>
                        </select>
                    </div>

                    <!-- Clone Options -->
                    <div id="create-clone-options"
                        style="display: none; margin-bottom: 15px; border: 1px solid #444; padding: 10px; border-radius: 8px;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <label>Namespace</label>
                                <select id="clone-ns-select" onchange="loadCloneResources()">
                                    <!-- populated by js -->
                                </select>
                            </div>
                            <div>
                                <label>Type</label>
                                <select id="clone-type-select" onchange="loadCloneResources()">
                                    <option value="deployments">Deployment</option>
                                    <option value="services">Service</option>
                                    <option value="configmaps">ConfigMap</option>
                                    <option value="secrets">Secret</option>
                                </select>
                            </div>
                            <div>
                                <label>Resource</label>
                                <select id="clone-resource-select" onchange="fetchCloneYaml()">
                                    <option value="">Select resource...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="create-editor-container" style="height: 400px; border: 1px solid #444;"></div>

                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="margin: 0; color: #ddd;">Target Namespace:</label>
                            <select id="create-target-ns" style="width: 200px; margin: 0;">
                                <option value="">Use YAML / Default</option>
                                <!-- populated by js -->
                            </select>
                        </div>

                        <div style="text-align: right;">
                            <button class="btn-classy" onclick="closeCreateModal()">Cancel</button>
                            <button class="btn-classy primary" onclick="applyResource()">Apply to Cluster</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="yaml-modal" class="modal" data-resource-url="">
                <div class="modal-content">
                    <span class="close" onclick="closeYamlModal()">&times;</span>
                    <!-- Replaced textarea with div for CodeMirror, though CM can replace textarea automatically -->
                    <textarea id="yaml-content"
                        style="display:none; width: 100%; height: calc(100% - 60px); background: #333; color: white; padding: 10px; border: 1px solid #444;"></textarea>
                    <div id="codemirror-container" style="height: calc(100% - 60px);"></div>
                    <div id="yaml-editor-warning" style="color: orange; display: none; margin-bottom: 5px;">Offline
                        Mode:
                        Syntax validation unavailable.</div>
                    <div class="modal-actions">
                        <button onclick="copyYamlToClipboard()">Copy to Clipboard</button>
                        <button id="edit-yaml-btn" onclick="enableYamlEditing()">Edit</button>
                        <button id="save-yaml-btn" onclick="saveYaml()" style="display: none;">Save</button>
                    </div>
                </div>
            </div>

            <div id="network-map-modal" class="modal">
                <div class="modal-content" style="width: 95%; height: 95%; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #444;">
                        <h2 style="margin: 0;">Cluster Network Map</h2>
                        <span class="close" onclick="closeNetworkMap()" style="font-size: 28px;">&times;</span>
                    </div>

                    <div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label for="map-namespace-select">Namespace:</label>
                            <select id="map-namespace-select" onchange="renderNetworkMap()">
                                <option value="all">All Namespaces</option>
                            </select>
                            <button onclick="renderNetworkMap()">Refresh Map</button>
                        </div>
                        <div>
                            <button id="btn-install-otterize" onclick="installOtterize()"
                                style="background: #e91e63; display: none;">Install Otterize (Enable Mapping)</button>
                        </div>
                    </div>

                    <!-- Main Content Area: Flex Row -->
                    <div style="display: flex; flex: 1; gap: 10px; overflow: hidden;">
                        <!-- Left: Map -->
                        <div style="flex: 3; display: flex; flex-direction: column;">
                            <!-- Installation Instructions -->
                            <div id="otterize-instructions"
                                style="display:none; padding:10px; background:#333; margin-bottom:10px; border-radius:5px;">
                                <p><strong>Otterize CLI Required for Full Features</strong></p>
                                <p>To view traffic map, Otterize must be installed in the cluster. Click "Install
                                    Otterize"
                                    above to install components.</p>
                                <p>For local CLI usage:</p>
                                <pre style="background:#111; padding:5px;">brew install otterize/otterize/otterize</pre>
                            </div>
                            <div id="network-map-container" style="flex: 1; border: 1px solid #444; background: #222;">
                            </div>
                        </div>

                        <!-- Right: Side Panel -->
                        <div id="map-side-panel"
                            style="flex: 1; background: #2a2a2a; border: 1px solid #444; display: flex; flex-direction: column;">
                            <div
                                style="padding: 10px; background: #333; font-weight: bold; border-bottom: 1px solid #444;">
                                Access Graph
                            </div>
                            <div style="flex: 1; overflow: auto; padding: 10px;">
                                <pre id="access-graph-text"
                                    style="color: #bbb; font-family: monospace; white-space: pre-wrap;">Select a namespace to view access graph...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="confirmation-modal" class="modal">
                <div class="modal-content">
                    <h3>Confirm Save</h3>
                    <p>Are you sure you want to save changes to this YAML?</p>
                    <div class="modal-actions" style="justify-content: center;">
                        <button onclick="confirmSave()">Confirm</button>
                        <button onclick="cancelSave()">Cancel</button>
                    </div>
                </div>
            </div>

            <script>
                let currentYamlUrl = '';
                let editor; // CodeMirror instance
                let currentNamespace = 'all'; // Global variable to store the currently selected namespace

                // Initialize CodeMirror when page loads
                window.onload = function () {
                    // Show disclaimer
                    document.getElementById('internet-disclaimer').style.display = 'block';

                    if (typeof CodeMirror !== 'undefined') {
                        // We'll initialize it but keep it empty until needed
                        editor = CodeMirror(document.getElementById('codemirror-container'), {
                            mode: 'yaml',
                            theme: 'monokai',
                            lineNumbers: true,
                            readOnly: true
                        });
                    } else {
                        console.warn('CodeMirror not loaded (Offline?)');
                    }
                };

                function showContent(contentId) {
                    const allContent = document.querySelectorAll('.page-content');
                    allContent.forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(`${contentId}-content`).style.display = 'block';
                }

                function showYamlModal(yaml, url) {
                    const textarea = document.getElementById('yaml-content');
                    const cmContainer = document.getElementById('codemirror-container');
                    const warning = document.getElementById('yaml-editor-warning');

                    if (editor) {
                        // Online Mode
                        textarea.style.display = 'none';
                        cmContainer.style.display = 'block';
                        warning.style.display = 'none';

                        editor.setValue(yaml);
                        editor.setOption('readOnly', true);
                        setTimeout(() => editor.refresh(), 10);
                    } else {
                        // Offline Fallback
                        textarea.style.display = 'block';
                        cmContainer.style.display = 'none';
                        warning.style.display = 'block';
                        textarea.value = yaml;
                        textarea.readOnly = true;
                    }

                    document.getElementById('edit-yaml-btn').style.display = 'inline-block';
                    document.getElementById('save-yaml-btn').style.display = 'none';

                    document.getElementById('yaml-modal').style.display = 'block';
                    document.getElementById('yaml-modal').setAttribute('data-resource-url', url);
                }

                function closeYamlModal() {
                    document.getElementById('yaml-modal').style.display = 'none';
                }

                function enableYamlEditing() {
                    if (editor) {
                        editor.setOption('readOnly', false);
                    } else {
                        document.getElementById('yaml-content').readOnly = false;
                    }
                    document.getElementById('edit-yaml-btn').style.display = 'none';
                    document.getElementById('save-yaml-btn').style.display = 'inline-block';
                }

                function copyYamlToClipboard() {
                    let yamlContent;
                    if (editor) {
                        yamlContent = editor.getValue();
                    } else {
                        yamlContent = document.getElementById('yaml-content').value;
                    }

                    navigator.clipboard.writeText(yamlContent).then(() => {
                        alert('YAML copied to clipboard!');
                    }, (err) => {
                        console.error('Failed to copy YAML: ', err);
                        alert('Failed to copy YAML. See console for details.');
                    });
                }

                function saveYaml() {
                    document.getElementById('confirmation-modal').style.display = 'block';
                }

                function cancelSave() {
                    document.getElementById('confirmation-modal').style.display = 'none';
                }

                async function confirmSave() {
                    const url = document.getElementById('yaml-modal').getAttribute('data-resource-url');
                    let yamlContent;
                    if (editor) {
                        yamlContent = editor.getValue();
                    } else {
                        yamlContent = document.getElementById('yaml-content').value;
                    }

                    try {
                        const response = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'text/yaml',
                            },
                            body: yamlContent,
                        });
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error);
                        }
                        alert('YAML saved successfully!');
                        document.getElementById('confirmation-modal').style.display = 'none';
                        closeYamlModal();
                        loadAllData();
                    } catch (error) {
                        console.error('Error saving YAML:', error);
                        alert(`Failed to save YAML: ${error.message}`);
                        document.getElementById('confirmation-modal').style.display = 'none';
                    }
                }

                async function fetchAndShowYaml(url) {
                    console.log('Fetching YAML from:', url);
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch YAML from ${url}`);
                        }
                        const yaml = await response.text();
                        showYamlModal(yaml, url);
                    } catch (error) {
                        console.error('Error fetching YAML:', error);
                    }
                }

                async function fetchNamespaces() {
                    try {
                        const response = await fetch('/api/namespaces');
                        if (!response.ok) {
                            throw new Error('Failed to fetch namespaces');
                        }
                        const data = await response.json();
                        const select = document.getElementById('namespace-select');
                        // Clear existing options except the first one
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        data.items.forEach(ns => {
                            const option = document.createElement('option');
                            option.value = ns.metadata.name;
                            option.textContent = ns.metadata.name;
                            select.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching namespaces:', error);
                    }
                }

                function filterByNamespace() {
                    currentNamespace = document.getElementById('namespace-select').value;
                    console.log('Filtering by namespace:', currentNamespace);
                    fetchAndRenderDeployments();
                    fetchAndRenderPods();
                    fetchAndRenderServices();
                    fetchAndRenderIngresses();
                    fetchAndRenderDaemonSets();
                    fetchAndRenderStatefulSets();
                    fetchAndRenderJobs();
                    fetchAndRenderCronJobs();
                    fetchAndRenderConfigMaps();
                    fetchAndRenderSecrets();
                }

                function renderDeployments(items, tableBody) {
                    items.forEach(deployment => {
                        const row = document.createElement('tr');
                        const namespace = deployment.metadata.namespace;
                        const name = deployment.metadata.name;
                        const replicas = deployment.spec.replicas;
                        const readyReplicas = deployment.status.readyReplicas || 0;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${replicas}</td>
                        <td>${readyReplicas}</td>
                        <td><button onclick="fetchAndShowYaml('/api/deployments/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderPods(items, tableBody) {
                    items.forEach(pod => {
                        const row = document.createElement('tr');
                        const namespace = pod.metadata.namespace;
                        const name = pod.metadata.name;
                        const status = pod.status.phase;
                        const node = pod.spec.nodeName;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${status}</td>
                        <td>${node}</td>
                        <td><button onclick="fetchAndShowYaml('/api/pods/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderServices(items, tableBody) {
                    items.forEach(service => {
                        const row = document.createElement('tr');
                        const namespace = service.metadata.namespace;
                        const name = service.metadata.name;
                        const type = service.spec.type;
                        const clusterIp = service.spec.clusterIP;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${type}</td>
                        <td>${clusterIp}</td>
                        <td><button onclick="fetchAndShowYaml('/api/services/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderIngresses(items, tableBody) {
                    items.forEach(ingress => {
                        const row = document.createElement('tr');
                        const namespace = ingress.metadata.namespace;
                        const name = ingress.metadata.name;
                        const hosts = ingress.spec.rules.map(rule => rule.host).join(', ');
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${hosts}</td>
                        <td><button onclick="fetchAndShowYaml('/api/ingresses/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderDaemonSets(items, tableBody) {
                    items.forEach(daemonset => {
                        const row = document.createElement('tr');
                        const namespace = daemonset.metadata.namespace;
                        const name = daemonset.metadata.name;
                        const desired = daemonset.status.desiredNumberScheduled;
                        const current = daemonset.status.currentNumberScheduled;
                        const ready = daemonset.status.numberReady;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${desired}</td>
                        <td>${current}</td>
                        <td>${ready}</td>
                        <td><button onclick="fetchAndShowYaml('/api/daemonsets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderStatefulSets(items, tableBody) {
                    items.forEach(statefulset => {
                        const row = document.createElement('tr');
                        const namespace = statefulset.metadata.namespace;
                        const name = statefulset.metadata.name;
                        const replicas = statefulset.spec.replicas;
                        const readyReplicas = statefulset.status.readyReplicas || 0;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${replicas}</td>
                        <td>${readyReplicas}</td>
                        <td><button onclick="fetchAndShowYaml('/api/statefulsets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderJobs(items, tableBody) {
                    items.forEach(job => {
                        const row = document.createElement('tr');
                        const namespace = job.metadata.namespace;
                        const name = job.metadata.name;
                        const completions = job.spec.completions;
                        const duration = job.status.completionTime ? new Date(job.status.completionTime) - new Date(job.status.startTime) : '-';
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${completions}</td>
                        <td>${duration}</td>
                        <td><button onclick="fetchAndShowYaml('/api/jobs/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderCronJobs(items, tableBody) {
                    items.forEach(cronjob => {
                        const row = document.createElement('tr');
                        const namespace = cronjob.metadata.namespace;
                        const name = cronjob.metadata.name;
                        const schedule = cronjob.spec.schedule;
                        const lastSchedule = cronjob.status.lastScheduleTime || '-';
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${schedule}</td>
                        <td>${lastSchedule}</td>
                        <td><button onclick="fetchAndShowYaml('/api/cronjobs/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderConfigMaps(items, tableBody) {
                    items.forEach(configmap => {
                        const row = document.createElement('tr');
                        const namespace = configmap.metadata.namespace;
                        const name = configmap.metadata.name;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td><button onclick="fetchAndShowYaml('/api/configmaps/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                function renderSecrets(items, tableBody) {
                    items.forEach(secret => {
                        const row = document.createElement('tr');
                        const namespace = secret.metadata.namespace;
                        const name = secret.metadata.name;
                        const type = secret.type;
                        row.innerHTML = `
                        <td>${namespace}</td>
                        <td>${name}</td>
                        <td>${type}</td>
                        <td><button onclick="fetchAndShowYaml('/api/secrets/${namespace}/${name}/yaml')">View YAML</button></td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                async function fetchAndRenderNodes() {
                    try {
                        const response = await fetch('/api/nodes');
                        if (!response.ok) {
                            throw new Error('Failed to fetch nodes');
                        }
                        const data = await response.json();
                        const tableBody = document.querySelector('#nodes-table tbody');
                        tableBody.innerHTML = '';
                        data.items.forEach(node => {
                            const row = document.createElement('tr');
                            const name = node.metadata.name;
                            const status = node.status.conditions.find(c => c.type === 'Ready').status;
                            const version = node.status.nodeInfo.kubeletVersion;
                            row.innerHTML = `
                            <td>${name}</td>
                            <td>${status}</td>
                            <td>${version}</td>
                            <td><button onclick="fetchAndShowYaml('/api/nodes/${name}/yaml')">View YAML</button></td>
                        `;
                            tableBody.appendChild(row);
                        });
                    } catch (error) {
                        console.error('Error fetching nodes:', error);
                    }
                }

                async function fetchAndRenderGeneric(resource, renderFunc, tableBodySelector) {
                    const selectedNamespace = document.getElementById('namespace-select').value;
                    const tableBody = document.querySelector(tableBodySelector);
                    tableBody.innerHTML = '';
                    try {
                        const response = await fetch(`/api/${resource}`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch ${resource}`);
                        }
                        const data = await response.json();
                        const filteredItems = selectedNamespace === 'all'
                            ? data.items
                            : data.items.filter(item => item.metadata.namespace === selectedNamespace);
                        renderFunc(filteredItems, tableBody);
                    } catch (error) {
                        console.error(`Error fetching ${resource}:`, error);
                    }
                }

                function fetchAndRenderDeployments() {
                    fetchAndRenderGeneric('deployments', renderDeployments, '#deployments-table tbody');
                }

                function fetchAndRenderPods() {
                    fetchAndRenderGeneric('pods', renderPods, '#pods-table tbody');
                }

                function fetchAndRenderServices() {
                    fetchAndRenderGeneric('services', renderServices, '#services-table tbody');
                }

                function fetchAndRenderIngresses() {
                    fetchAndRenderGeneric('ingresses', renderIngresses, '#ingresses-table tbody');
                }

                function fetchAndRenderDaemonSets() {
                    fetchAndRenderGeneric('daemonsets', renderDaemonSets, '#daemonsets-table tbody');
                }

                function fetchAndRenderStatefulSets() {
                    fetchAndRenderGeneric('statefulsets', renderStatefulSets, '#statefulsets-table tbody');
                }

                function fetchAndRenderJobs() {
                    fetchAndRenderGeneric('jobs', renderJobs, '#jobs-table tbody');
                }

                function fetchAndRenderCronJobs() {
                    fetchAndRenderGeneric('cronjobs', renderCronJobs, '#cronjobs-table tbody');
                }

                function fetchAndRenderConfigMaps() {
                    fetchAndRenderGeneric('configmaps', renderConfigMaps, '#configmaps-table tbody');
                }

                function fetchAndRenderSecrets() {
                    fetchAndRenderGeneric('secrets', renderSecrets, '#secrets-table tbody');
                }

                async function fetchRepositories() {
                    const list = document.querySelector('#repositories-list');
                    const setupDiv = document.getElementById('registry-setup');
                    const errorDiv = document.getElementById('registry-error');
                    const errorMsg = document.getElementById('registry-error-msg');
                    const installInstr = document.getElementById('reg-install-instructions');
                    const insecureInstr = document.getElementById('docker-insecure-instructions');

                    list.innerHTML = 'Loading...';
                    errorDiv.style.display = 'none';
                    installInstr.style.display = 'none';
                    insecureInstr.style.display = 'none';

                    try {
                        const response = await fetch('/api/repositories');
                        const data = await response.json();

                        if (!response.ok) {
                            if (data.details && data.details.type === 'NOT_INSTALLED') {
                                throw new Error('NOT_INSTALLED');
                            } else if (data.details && data.details.type === 'HTTPS_MISMATCH') {
                                throw new Error('HTTPS_MISMATCH');
                            } else if (data.details && data.details.type === 'EXEC_ERROR') {
                                throw new Error(`Connection failed: ${data.details.message}. Please check your configuration.`);
                            }
                            throw new Error('Failed to fetch repositories');
                        }

                        list.innerHTML = '';
                        if (data.length === 0) {
                            list.innerHTML = '<li>No repositories found.</li>';
                        }
                        data.forEach(repo => {
                            const item = document.createElement('li');
                            item.textContent = repo;
                            list.appendChild(item);
                        });
                        // If successful, we might hide setup, or keep it visible/accessible
                        setupDiv.style.display = 'block';
                    } catch (error) {
                        console.error('Error fetching repositories:', error);
                        setupDiv.style.display = 'block'; // Show setup on error so user can fix URL
                        errorDiv.style.display = 'block';
                        list.innerHTML = '';

                        if (error.message === 'NOT_INSTALLED') {
                            errorMsg.textContent = 'The "reg" command line tool is not installed or not found in PATH.';
                            installInstr.style.display = 'block';
                        } else if (error.message === 'HTTPS_MISMATCH') {
                            errorMsg.textContent = 'Connection Error: server gave HTTP response to HTTPS client.';
                            insecureInstr.style.display = 'block';
                            // Update content with actual registry URL if available
                            const currentUrl = document.getElementById('registry-url').value || 'YOUR_REGISTRY_URL';
                            insecureInstr.innerHTML = insecureInstr.innerHTML.replace('YOUR_REGISTRY_URL', currentUrl);
                        } else {
                            errorMsg.textContent = error.message;
                        }
                    }
                }

                async function saveRegistryConfig() {
                    const url = document.getElementById('registry-url').value;
                    const username = document.getElementById('registry-username').value;
                    const password = document.getElementById('registry-password').value;
                    const isSecure = document.getElementById('registry-secure').checked;
                    try {
                        const response = await fetch('/api/config/registry', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url, username, password, isSecure })
                        });
                        if (response.ok) {
                            alert('Configuration saved!');
                            fetchRepositories();
                        } else {
                            alert('Failed to save configuration');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Error saving configuration');
                    }
                }

                async function loadRegistryConfig() {
                    try {
                        const res = await fetch('/api/config/registry');
                        if (res.ok) {
                            const data = await res.json();
                            if (data.url) {
                                document.getElementById('registry-url').value = data.url;
                            }
                            if (data.username) {
                                document.getElementById('registry-username').value = data.username;
                            }
                            if (data.isSecure !== undefined) {
                                document.getElementById('registry-secure').checked = data.isSecure;
                            } else {
                                document.getElementById('registry-secure').checked = false; // Default off
                            }
                            // Don't autofill password for security/UX reasons, or could if desired.
                            // Leaving blank for now.
                        }
                    } catch (e) { console.error(e); }
                }

                async function loadAllData() {
                    document.getElementById('welcome-message') && (document.getElementById('welcome-message').style.display = 'none');
                    try {
                        await Promise.all([
                            fetchNamespaces(),
                            fetchAndRenderNodes(),
                            fetchAndRenderDeployments(),
                            fetchAndRenderPods(),
                            fetchAndRenderServices(),
                            fetchAndRenderIngresses(),
                            fetchAndRenderDaemonSets(),
                            fetchAndRenderStatefulSets(),
                            fetchAndRenderJobs(),
                            fetchAndRenderCronJobs(),
                            fetchAndRenderConfigMaps(),
                            fetchAndRenderSecrets(),
                            loadRegistryConfig(),
                            fetchRepositories()
                        ]);
                        filterByNamespace();
                    } catch (e) {
                        console.error('Error loading initial data', e);
                        alert('Error loading initial data: ' + e.message);
                    }
                }

                async function loadContexts() {
                    try {
                        const res = await fetch('/api/contexts');
                        const data = await res.json();
                        const selector = document.getElementById('context-selector');
                        selector.innerHTML = '';

                        if (data.contexts && Array.isArray(data.contexts)) {
                            data.contexts.forEach(ctx => {
                                const opt = document.createElement('option');
                                opt.value = ctx;
                                opt.textContent = ctx;
                                if (ctx === data.currentContext) {
                                    opt.selected = true;
                                }
                                selector.appendChild(opt);
                            });
                        }
                    } catch (err) {
                        console.error('Failed to load contexts', err);
                    }
                }

                async function switchContext(contextName) {
                    try {
                        const res = await fetch('/api/contexts/current', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ context: contextName })
                        });
                        if (res.ok) {
                            loadAllData();
                        } else {
                            alert('Failed to switch context');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error switching context');
                    }
                }

                // Network Map Logic
                async function showNetworkMap() {
                    document.getElementById('network-map-modal').style.display = 'block';

                    // Populate namespace selector in modal (clone from main or fetch)
                    const mainNsSelect = document.getElementById('namespace-select');
                    const mapNsSelect = document.getElementById('map-namespace-select');

                    // Preserve selection if possible, else copy all
                    const currentVal = mapNsSelect.value;
                    mapNsSelect.innerHTML = mainNsSelect.innerHTML;
                    // Add 'All Namespaces' if removed or just ensure it's there
                    // The main selector might not have 'all' if it's strict. Let's force it.
                    // Actually main selector logic is: <option value="all">All Namespaces</option> + others.
                    if (mainNsSelect.value) mapNsSelect.value = mainNsSelect.value;

                    // Check Otterize Status to toggle Install Button
                    try {
                        const res = await fetch('/api/otterize/status');
                        const status = await res.json();
                        const installBtn = document.getElementById('btn-install-otterize');
                        if (status.installed) {
                            installBtn.style.display = 'none';
                        } else {
                            installBtn.style.display = 'block';
                        }
                    } catch (e) {
                        console.error('Failed to check otterize status', e);
                    }

                    renderNetworkMap();
                }

                function closeNetworkMap() {
                    document.getElementById('network-map-modal').style.display = 'none';
                }

                async function renderNetworkMap() {
                    const container = document.getElementById('network-map-container');
                    const namespace = document.getElementById('map-namespace-select').value;
                    const accessGraphText = document.getElementById('access-graph-text');

                    // Fallback for offline usage
                    if (typeof vis === 'undefined') {
                        container.innerHTML = '<div style="color:orange; padding:20px; text-align:center;"><h3>Network Map Unavailable</h3><p>Vis.js library failed to load (Offline?). Internet access is required for this feature.</p></div>';
                        return;
                    }

                    container.innerHTML = '<div style="color:white; padding:20px;">Loading map data...</div>';
                    accessGraphText.textContent = 'Loading...';

                    try {
                        const res = await fetch(`/api/network-map?namespace=${namespace}`);
                        if (!res.ok) throw new Error('Failed to fetch map data');
                        const data = await res.json();

                        if (data.edges.length === 0) {
                            // Check if users might need to install otterize
                            // Only show instructions if NOT installed
                            const installBtn = document.getElementById('btn-install-otterize');
                            if (installBtn.style.display !== 'none') {
                                document.getElementById('otterize-instructions').style.display = 'block';
                            } else {
                                document.getElementById('otterize-instructions').style.display = 'none';
                            }
                        } else {
                            document.getElementById('otterize-instructions').style.display = 'none';
                        }

                        // Render Textual Graph (CLI Simulation)
                        renderAccessList(data);

                        // Create Vis.js data
                        const nodes = new vis.DataSet(data.nodes);
                        const edges = new vis.DataSet(data.edges);

                        const mapData = { nodes: nodes, edges: edges };
                        const options = {
                            nodes: {
                                shape: 'box',
                                margin: 10,
                                font: { color: 'black' },
                                color: { background: '#2196F3', border: '#0D47A1' }
                            },
                            edges: {
                                arrows: {
                                    to: {
                                        enabled: true,
                                        scaleFactor: 1.2
                                    }
                                },
                                color: {
                                    color: '#ffffff',
                                    highlight: '#ff9800', // Orange on click
                                    hover: '#ff9800',
                                    inherit: false,
                                    opacity: 1.0
                                },
                                width: 2,
                                smooth: {
                                    type: 'continuous'
                                }
                            },
                            physics: {
                                enabled: true,
                                barnesHut: {
                                    gravitationalConstant: -4000,
                                    centralGravity: 0.1,
                                    springLength: 250,
                                    springConstant: 0.04,
                                    damping: 0.09,
                                    avoidOverlap: 1
                                },
                            },
                            layout: {
                                randomSeed: 2
                            }
                            // layout: {
                            //     hierarchical: {
                            //         direction: 'LR', // Left to Right
                            //         sortMethod: 'directed',
                            //         levelSeparation: 150,
                            //         nodeSpacing: 100,
                            //         treeSpacing: 200
                            //     }
                            // }
                        };

                        new vis.Network(container, mapData, options);

                    } catch (err) {
                        console.error(err);
                        container.innerHTML = `<div style="color:red; padding:20px;">Error loading map: ${err.message}</div>`;
                        accessGraphText.textContent = 'Error loading data.';
                    }
                }

                function renderAccessList(data) {
                    // data.nodes = [{id, label, group...}]
                    // data.edges = [{from, to...}]

                    // Guidance for empty state
                    if (data.edges.length === 0) {
                        document.getElementById('access-graph-text').innerHTML = `
<div style="color: #ccc; padding: 10px;">
    <strong>No Traffic Detected</strong>
    <p>The network map shows <em>active traffic</em> between services.</p>
    <p><strong>To populate the map:</strong></p>
    <ol style="padding-left: 20px; line-height: 1.6;">
        <li>Ensure Otterize is installed (Status: <span id="ott-status-txt">Checking...</span>).</li>
        <li><strong>Generate Traffic:</strong> Interact with your applications (e.g., make HTTP requests, trigger jobs).</li>
        <li>Wait 30-60 seconds for the mapper to aggregate data.</li>
        <li>Click <strong>Refresh Map</strong>.</li>
    </ol>
</div>`;
                        // Check status for the help text
                        fetch('/api/otterize/status').then(r => r.json()).then(s => {
                            const el = document.getElementById('ott-status-txt');
                            if (el) el.textContent = s.installed ? 'Installed âœ…' : 'Not Installed âŒ';
                            if (el) el.style.color = s.installed ? 'lightgreen' : 'red';
                        });

                        return;
                    }

                    // Group edges by source
                    const map = {}; // sourceID -> [targetIDs]

                    data.nodes.forEach(n => {
                        map[n.id] = { name: n.label, ns: n.group, calls: [] };
                    });

                    data.edges.forEach(e => {
                        if (map[e.from]) {
                            // Resolve target name
                            const targetNode = data.nodes.find(n => n.id === e.to);
                            const targetName = targetNode ? targetNode.label : e.to;
                            if (!map[e.from].calls.includes(targetName)) {
                                map[e.from].calls.push(targetName);
                            }
                        }
                    });

                    let output = '';
                    // Format:
                    // frontend in namespace otterize-ecom-demo calls:
                    //   - cartservice

                    Object.values(map).forEach(item => {
                        if (item.calls.length > 0) {
                            output += `${item.name} in namespace ${item.ns} calls:\n`;
                            item.calls.sort().forEach(target => {
                                output += `  - ${target}\n`;
                            });
                            output += '\n';
                        }
                    });

                    document.getElementById('access-graph-text').textContent = output;
                }

                async function installOtterize() {
                    try {
                        const res = await fetch('/api/otterize/install', { method: 'POST' });
                        const data = await res.json();
                        alert(data.message);
                        document.getElementById('otterize-instructions').style.display = 'block';
                    } catch (err) {
                        alert('Failed to start installation: ' + err.message);
                    }
                }

                // --- Create Resource Logic ---
                let createEditor;

                function openCreateModal() {
                    document.getElementById('create-resource-modal').style.display = 'block';

                    // Init editor if needed
                    if (!createEditor) {
                        const container = document.getElementById('create-editor-container');
                        if (typeof CodeMirror !== 'undefined') {
                            createEditor = CodeMirror(container, {
                                mode: 'yaml',
                                theme: 'monokai',
                                lineNumbers: true,
                                tabSize: 2
                            });
                        } else {
                            container.innerHTML = '<textarea id="create-fallback-textarea" style="width:100%; height:100%; background:#222; color:white;"></textarea>';
                        }
                    }

                    // Reset
                    document.getElementById('create-mode-select').value = 'template';
                    toggleCreateMode();

                    // Populate namespaces for clone AND target
                    const mainNs = document.getElementById('namespace-select');
                    const cloneNs = document.getElementById('clone-ns-select');
                    const targetNs = document.getElementById('create-target-ns');

                    cloneNs.innerHTML = mainNs.innerHTML;
                    if (cloneNs.querySelector('option[value="all"]')) cloneNs.querySelector('option[value="all"]').remove();

                    targetNs.innerHTML = '<option value="">Use YAML / Default</option>' + mainNs.innerHTML;
                    // Remove 'All Namespaces' from target if present (usually strictly 'all' isn't valid for creation)
                    const allOpt = targetNs.querySelector('option[value="all"]');
                    if (allOpt) allOpt.remove();

                    // Select current namespace if valid
                    if (currentNamespace && currentNamespace !== 'all') {
                        targetNs.value = currentNamespace;
                    }
                }

                function closeCreateModal() {
                    document.getElementById('create-resource-modal').style.display = 'none';
                }

                function getCreateYaml() {
                    if (createEditor) return createEditor.getValue();
                    const ta = document.getElementById('create-fallback-textarea');
                    return ta ? ta.value : '';
                }

                function setCreateYaml(val) {
                    if (createEditor) createEditor.setValue(val);
                    const ta = document.getElementById('create-fallback-textarea');
                    if (ta) ta.value = val;
                }

                function toggleCreateMode() {
                    const mode = document.getElementById('create-mode-select').value;
                    document.getElementById('create-template-options').style.display = mode === 'template' ? 'block' : 'none';
                    document.getElementById('create-clone-options').style.display = mode === 'clone' ? 'block' : 'none';
                    setCreateYaml('# Select a template or resource to start...');
                }

                const TEMPLATES = {
                    deployment: `apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-container
        image: nginx:latest
        ports:
        - containerPort: 80`,
                    service: `apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
spec:
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP`,
                    pvc: `apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi`,
                    configmap: `apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
  namespace: default
data:
  config.yaml: |
    key: value`,
                    secret: `apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  namespace: default
type: Opaque
stringData:
  username: admin
  password: changeit`,
                    ingress: `apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  namespace: default
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-service
            port:
              number: 80`
                };

                function loadTemplate() {
                    const type = document.getElementById('template-type-select').value;
                    if (TEMPLATES[type]) {
                        setCreateYaml(TEMPLATES[type]);
                    }
                }

                async function loadCloneResources() {
                    const ns = document.getElementById('clone-ns-select').value;
                    // Mapped to API endpoints. 
                    // Need logic to fetch list similar to main view but raw names.
                    // Re-using existing endpoints?
                    // api/deployments etc return list.
                    const type = document.getElementById('clone-type-select').value;
                    const resSelect = document.getElementById('clone-resource-select');
                    resSelect.innerHTML = '<option>Loading...</option>';

                    try {
                        const res = await fetch(`/api/${type}`); // e.g. /api/deployments
                        const data = await res.json();
                        // Filter by namespace
                        const items = data.items.filter(i => i.metadata.namespace === ns);

                        resSelect.innerHTML = '<option value="">Select...</option>';
                        items.forEach(i => {
                            const opt = document.createElement('option');
                            opt.value = i.metadata.name;
                            opt.innerText = i.metadata.name;
                            resSelect.appendChild(opt);
                        });
                    } catch (e) {
                        console.error(e);
                        resSelect.innerHTML = '<option>Error loading</option>';
                    }
                }

                async function fetchCloneYaml() {
                    const ns = document.getElementById('clone-ns-select').value;
                    const typePlural = document.getElementById('clone-type-select').value;
                    const name = document.getElementById('clone-resource-select').value;
                    if (!name) return;

                    // Need singular type for yaml endpoint: /api/deployments/:ns/:name/yaml
                    // Wait, existing endpoints are specific.
                    // api/deployments/:ns/:name/yaml works. 
                    // api/services/:ns/:name/yaml works.
                    // Let's use the one consistent endpoint structure:

                    try {
                        const res = await fetch(`/api/${typePlural}/${ns}/${name}/yaml`);
                        let text = await res.text();

                        // Strip specific metadata to make it cloneable
                        // Simple regex or just dump as is and user edits
                        setCreateYaml(text);
                    } catch (e) {
                        alert('Failed to load YAML');
                    }
                }

                async function applyResource() {
                    const yamlContent = getCreateYaml();
                    const targetNs = document.getElementById('create-target-ns').value;
                    if (!yamlContent) return;

                    if (!confirm(`Apply this configuration to the cluster?${targetNs ? ` (Namespace: ${targetNs})` : ''}`)) return;

                    try {
                        const res = await fetch('/api/resources/apply', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                yaml: yamlContent,
                                context: currentContext, // Be sure this variable is available globally
                                namespace: targetNs
                            })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert('Resource Created/Applied Successfully!\n' + data.output);
                            closeCreateModal();
                            loadAllData(); // Refresh lists
                        } else {
                            alert('Failed: ' + data.details);
                        }
                    } catch (e) {
                        alert('Error applying resource: ' + e.message);
                    }
                }


                // Initialize
                loadContexts().then(() => {
                    // Default view
                    showContent('nodes');
                    loadAllData();
                });
            </script>
            <!-- Footer -->
            <footer style="text-align: center; padding: 20px; color: #666; font-size: 0.9em; margin-top: auto;">
                Made with &lt;3 by @imranfosec
            </footer>
</body>

</html>